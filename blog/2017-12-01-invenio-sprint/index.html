<!doctype html>
<title>Sprint: Elasticsearch v5 support â€” inveniosoftware.org</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="keywords" content="invenio, library, framework, ils, research, data, multimedia, ir, institutional, repository, cern, foss, open, software, model, search, workflows, marc, marc21, python, api, doi, json, memento, oai-pmh, orcid, openaire, rest, zenodo, cds, flask, angular">
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.min.js"></script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/4.0.1/ekko-lightbox.min.js"></script>
<link rel="icon" href="/static/img/favicon.ico?h=4df2b1b9">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/css/style.css?h=af726eb9">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600|Oswald|Source+Code+Pro:400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/4.0.1/ekko-lightbox.css" />
<body>
  
  
    <section class="header-section " >
      <div class="cover-image">
        
          <header class="header-nav">
  <nav class="navbar navbar-fixed-top invenio-navbar">
    <div class="container">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#inv-navbar-collapse" aria-controls="inv-navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" class="navbar-brand">
          <img src="/static/img/logo-invenio-white.svg?h=84611f18" alt="">
        </a>
      </div>
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse" id="inv-navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          
            
              <li><a href="/">Home</a></li>
            
          
            
              <li class="dropdown-submenu">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <span class="nav-label">Products</span><span class="caret"></span></a>
                <ul class="dropdown-menu">
                  
                    <li><a href="/products/rdm/">InvenioRDM</a></li>
                  
                    <li><a href="/products/ils/">InvenioILS</a></li>
                  
                    <li><a href="/products/framework/">Invenio Framework</a></li>
                  
                </ul>
              </li>
            
          
            
              <li><a href="/showcase/">Examples</a></li>
            
          
            
              <li class="dropdown-submenu">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <span class="nav-label">Community</span><span class="caret"></span></a>
                <ul class="dropdown-menu">
                  
                    <li><a href="/roadmap/">Roadmap</a></li>
                  
                    <li><a href="/getinvolved/">Get involved</a></li>
                  
                    <li><a href="/events/">Events &amp; Training</a></li>
                  
                    <li><a href="/support/">Hosting &amp; Support</a></li>
                  
                    <li><a href="/governance/">Governance</a></li>
                  
                    <li><a href="/people/">People</a></li>
                  
                </ul>
              </li>
            
          
            
              <li><a href="/documentation/">Docs</a></li>
            
          
            
              <li><a class="active-menu" href="/blog/">Blog</a></li>
            
          
            
              <li><a href="https://invenio-talk.web.cern.ch">Talk</a></li>
            
          
            
              <li><a href="/about/">About</a></li>
            
          
        </ul>
      </div>
    </div>
  </nav>
</header>
        
        <div class="container">
          <div class="row">
            <div class="col">
              <div class="header-section-title">
                
                <h1>Invenio Blog</h1>
                <p class="sub-title">Follow news and updates on Invenio world</p>
                
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </section>
  
  
  <section id="blog-post-content-section" class="section-content-light-bg">
    <div class="container">
      <div class="row">
        <div class="col-md-8 col-xs-12 block-center">
            
  <div class="blog-back-button">
    <a href="/blog">Back</a>
  </div>
  <div class="blog-post blog-post-frame">
    <header class="post-header">
      <h2>
        
          Sprint: Elasticsearch v5 support
        
      </h2>
      <p class="post-meta">
        <i class='fa fa-user text-muted'></i>
        <span class="author">
          
            <a href="https://twitter.com/larshankat">Lars Holm Nielsen</a>
          
        </span>
        <i class='fa fa-calendar text-muted'></i>
        <span>Dec 1, 2017</span>
        <i class='fa fa-users text-muted'></i>
        <span class="label invenio-team"><a class="team-url" href="https://discord.gg/8qatqBC">Invenio Framework</a></span>
      </p>
    </header>
    <article class="post-content">
      <p>This sprint was focused on:</p>
<ul>
<li>Elasticsearch v5 support</li>
<li>Preparing to release the metadata bundle.</li>
<li>Removing remaining Invenio-DB warnings.</li>
</ul>
<p>During the sprint 60 developer days were spent, 52 commits were created and 4.3k lines were touched (3.1k additions and 1.2k deletions).</p>
<h2>List of changes:</h2>
<ul>
<li>Cookiecutter-Invenio-Module:<ul>
<li>Minor various fixes for build issues.</li>
</ul>
</li>
<li>IDUtils (v1.0.0):<ul>
<li>global: fix DOI Unicode issues</li>
</ul>
</li>
<li>Invenio-Base (v1.0.0b1)<ul>
<li>Cookiecutter template removal (to be replaced by upcoming cookiecutter-invenio-instance).</li>
<li>Release checklist, docs build errors, 100% test coverage.</li>
</ul>
</li>
<li>Invenio-DB (v1.0.0b9)<ul>
<li>Remove annoying warning.</li>
</ul>
</li>
<li>Invenio-I18N (v1.0.0b4)<ul>
<li>Example app rendering on ReadTheDocs</li>
</ul>
</li>
<li>Invenio-Indexer (v1.0.0b1):<ul>
<li><strong>New BulkRecordIndexer class with RecordIndexer-compatible API (to be used
by Invenio-Records-REST).</strong></li>
<li>Elasticsearch v5 support.</li>
<li>Release checklist.</li>
</ul>
</li>
<li>Invenio-JSONSchemas (v1.0.0a7)<ul>
<li>Documentation improvements.</li>
<li>Release checklist.</li>
</ul>
</li>
<li>Invenio-Mail (v1.0.0b1)<ul>
<li>Broken docs build fix (related to Celery problem).</li>
</ul>
</li>
<li>Invenio-OAIServer (v1.0.0b1)<ul>
<li><strong>Description support in Identify verb (eprints, friends etc).</strong></li>
<li>Elasticsearch v5 support.</li>
<li>Release checklist + documentation improvements.</li>
<li>License change PR</li>
</ul>
</li>
<li>Invenio-OAuth2Server (v1.0.0b3)<ul>
<li>Unpinned oauthlib.</li>
</ul>
</li>
<li>Invenio-PIDStore (v1.0.0b2)<ul>
<li>Release checklist.</li>
</ul>
</li>
<li>Invenio-Records-REST (v1.0.0b5)<ul>
<li><strong>Index after create, update and delete record creation (this will later
impact Invenio-Deposit).</strong></li>
<li><strong>Serializers refactored to be more easily composable.</strong></li>
<li><strong>Improved tombstone handling for the REST API (e.g. include removal
reason).</strong></li>
<li>Elasticsearch v5 support.</li>
<li>Improved documentation.</li>
<li>Dynamic aggregations.</li>
<li>Release checklist.</li>
</ul>
</li>
<li>Invenio-Records-UI (v1.0.0b2)<ul>
<li>Release checklist + example app docs fix for RTD.</li>
</ul>
</li>
<li>Invenio-Search (v1.0.0b4)<ul>
<li><strong>Elasticsearch v5 support (via version-specific mappings).</strong></li>
<li>Support for creating only specific indexes.</li>
<li>CLI for listing all indexes and aliases.</li>
</ul>
</li>
<li>Invenio-Search-UI (v1.0.0a9)<ul>
<li>Release checklist.</li>
</ul>
</li>
<li>Invenio-MARC21 (v1.0.0a6)<ul>
<li>Elasticsearch v5 support.</li>
</ul>
</li>
</ul>
<h2>Elasticsearch 5 support</h2>
<p>Search, Indexer, Records-REST, OAIServer and MARC21 have all been upgraded to
support Elasticsearch v2 and v5. Elasticsearch v6 is not yet support due to the
elasticsearch-dsl package not yet supporting v6 (support already merged in master branch but not yet released).</p>
<p>Other Invenio packages have not yet been upgraded to Elasticsearch v5. E.g.
Records-Files, OpenAIRE, Stats, Collections, OpenDefinition, Query-Parser have
not yet been tested with Elasticsearch v5.</p>
<h3>Choosing version</h3>
<p>You will need to know at install-time which version of Elasticsearch you'd like
to use. For instance to use Elasticsearch 5 you need to install Invenio-Search
like this:</p>
<pre><code class="lang-console">$ pip install invenio-search[elasticsearch5]
</code></pre>
<h3>Mappings</h3>
<p>Due to the differences between Elasticsearch versions, we have opted for
<em>version-specific mappings</em>. This means that Invenio modules must provide a
mapping per Elasticsearch version they wish to support. E.g. today, the mapping
is placed in a directory like e.g.:</p>
<pre><code>mappings/records/record-v1.0.0.json
</code></pre>
<p>To support Elasticsearch v2 and v5 you now need two mappings:</p>
<pre><code>mappings/v2/records/record-v1.0.0.json
mappings/v5/records/record-v1.0.0.json
</code></pre>
<p>Note that mappings for Elasticsearch v2 may use either the <code>mappings/v2</code>
directory or the <code>mappings/</code> directory like previously (for backward
compatibility).</p>
<h3>Adding Elasticsearch v5 support to a module</h3>
<p>In case you have site-specific modules and would like to add Elasticsearch v5
support here's a rough guide:</p>
<ul>
<li>Update <code>travis.yml</code> to test both v2 and v5 (<a href="https://github.com/inveniosoftware/invenio-indexer/pull/75/files#diff-354f30a63fb0907d4ad57269548329e3">example</a>)</li>
<li>Update <code>setup.py</code> by moving Invenio-Search dependency to <code>extra_require</code> (<a href="https://github.com/inveniosoftware/invenio-records-rest/pull/177/files#diff-2eeaed663bd0d25b7e608891384b7298">example</a>).</li>
<li>Move existing mappings and add new mappings for v5 (<a href="https://github.com/inveniosoftware/invenio-records-rest/pull/177/files#diff-35e3e3c8ab14c00d11908b83ffa1fc36">example</a>)<ul>
<li>Most common change from v2 to v5 is the change from <code>string</code> type to either <code>text</code> or <code>keyword</code> type.</li>
</ul>
</li>
<li>Update <code>docs/requirements.txt</code> by adding <code>elasticsearch5</code> as an extra requirement to ensure ReadTheDocs builds will be fine.</li>
<li>Fix any API specific calls (see below).</li>
</ul>
<h3>Canonical way of checking for ES version.</h3>
<pre><code class="lang-python">from elasticsearch import VERSION as ES_VERSION

if ES_VERSION[0] == 2:
    # ...
</code></pre>
<h3>Completion Suggesters</h3>
<p>The Completion Suggesters have changed from v2 to v5. In v2, suggesters
supported an index-time <code>payloads</code> option, which was used to store and
return metadata with suggestions. In v5, completions are now returned with
their associated document in the <code>_source</code> field.</p>
<p>If you have completion suggesters for v2 you will need to make them compatible
with v5. This involves:</p>
<ul>
<li>API clients should read metadata from <code>_source</code> instead of <code>payload</code>. For
v2 the payload is copied to <code>_source</code> by Records-REST, which allows you to
already now upgrade API clients to use the new <code>_source</code> field.</li>
<li>On indexing, you need to add the payload only for v2.</li>
</ul>
<h3>Elasticsearch v2 end-of-life</h3>
<p>Elasticsearch v2 reaches end of life in
<a href="https://www.elastic.co/support/eol">February 2018</a>. Elasticsearch v2 support in
Invenio will be removed in Invenio v3.1, thus Invenio v3.0 will be released
with Elasticsearch v2 support and be maintained until v3.0 end of life
(currently TBD).</p>

    </article>
    
  </div>

        </div>
      </div>
    </div>
  </section>
  
  <script type="text/javascript">
    $(document).ready(function() {
        $(document).delegate('*.post-content img', 'click', function(event) {
            $(this).data('remote', $(this).attr('src'));
            event.preventDefault(); $(this).ekkoLightbox();
        });
    });
  </script>


  <footer>
  <div class="contact-section section-content-dark-bg">
    <div class="container">
      <div class="row">
  <div class="col-md-6 footer-logo-centered">
    <a href="/"><img class="icon-contact" src="/static/img/logo-invenio-white.svg?h=84611f18" /></a>
  </div>
  <div class="col-md-2">
    <h3 class="contact-title">Products</h3>
    <table class="contact-list">
      <tbody>
        <tr>
          <td><a href="/products/rdm/">InvenioRDM</a></td>
        </tr>
        <tr>
          <td>
            <a href="/products/ils/">InvenioILS</a>
          </td>
        </tr>
        <tr>
          <td>
            <a href="/products/framework/">Invenio Framework</a>
          </td>
        </tr>
        <tr>
          <td>
            <a href="/#products">Get Started</a>
          </td>
        </tr>
        <tr>
          <td>
            <a href="/showcase/">Examples</a>
          </td>
        </tr>
        <tr>
          <td><a href="/about/">About</a></td>
        </tr>
        <tr>
          <td><a href="/about#logos">Logos</a></td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="col-md-2">
    <h3 class="contact-title">Community</h3>
    <table class="contact-list">
      <tbody>
        <tr>
          <td><a href="/roadmap/">Roadmap</a></td>
        </tr>
        <tr>
          <td>
            <a href="/getinvolved/">Get Involved</a>
          </td>
        </tr>
        <tr>
          <td>
            <a href="/events/">Events & Training</a>
          </td>
        </tr>
        <tr>
          <td>
            <a href="/support/">Hosting & Support</a>
          </td>
        </tr>
        <tr>
          <td>
            <a href="/governance/">Governance</a>
          </td>
        </tr>
        <tr>
          <td>
            <a href="/people/">People</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="col-md-2">
    <h3 class="contact-title">Keep in touch</h3>
    <table class="contact-list">
      <tbody>
        <tr>
          <td>
            <a href="https://github.com/inveniosoftware">GitHub</a>
          </td>
        </tr>
        <tr>
          <td>
            <a href="https://discord.gg/8qatqBC">Chatroom</a>
          </td>
        </tr>
        <tr>
          <td>
            <a href="https://invenio-talk.web.cern.ch">Talk</a>
          </td>
        </tr>
        <tr>
          <td>
            <a href="https://twitter.com/inveniosoftware">Twitter</a>
          </td>
        </tr>
        <tr>
          <td><a href="/blog/">Blog</a></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
    </div>
  </div>
  <div class="footer-bottom">
    <div class="container">
      <div class="row">
        <div class="col-md-12 centered">
          <span>Copyright &copy; 2016-<span id="currentYear"></span> CERN &amp; contributors. Icons by <a href="http://fontawesome.io/">Font Awesome</a> and <a href="https://icons8.com/">Icons8</a>. Text is licensed under Creative Commons Attribution 4.0 International.<br>
          <span class="text-muted"><small></small></span>
        </div>
      </div>
    </div>
  </div>
</footer>
<script>
  var currentDate = new Date();
  var currentYear = currentDate.getFullYear();
  document.getElementById("currentYear").innerText = currentYear;
</script>
  <!-- Matomo -->
<script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="https://webanalytics.web.cern.ch/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '233']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
</script>
<!-- End Matomo Code -->


  <script>
    //Main navigation scroll spy for shadow
    $(window).scroll(function() {
      var y = $(window).scrollTop();
      if (y > 0) {
        $(".invenio-navbar").addClass('invenio-navbar-not-top');
      } else {
        $(".invenio-navbar").removeClass('invenio-navbar-not-top');
      }
    });
  </script>
</body>
